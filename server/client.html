<html>
  <head>
    <title>Socket.io Test</title>
        
    <script src="/json.js"></script> <!-- for ie -->
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    
    <script>
        
    
    var socket;
    var firstconnect = true;
    var socketid = null; // the other end!!
    window.onLoad = connect();
        
    function connect() {
      if(firstconnect) {
        socket = io.connect(null);
          
        socket.on('message', function(data){ 
          message(data); 
        });
        
        socket.on('connect', function() { 
          status_update("Connected to Server"); 
        });
        
        socket.on('disconnect', function() { 
          status_update("Disconnected from Server"); 
        });
        
        socket.on('reconnect', function(){ 
          status_update("Reconnected to Server"); 
        });
        
        socket.on('reconnecting', function( nextRetry ) { 
          status_update("Reconnecting in " + nextRetry + " seconds"); 
        });
        
        socket.on('reconnect_failed', function() { 
          message("Reconnect Failed"); 
        });
        
        socket.on('chat', function(message) { 
          handleChat(message); 
        });
        
        socket.on('discard', function(data) { 
          handleDiscard(data); 
        });
        
        socket.on('setup', function(info) {
          handleSetup(info);
        });
        
        socket.on('result', function(result) { handleResult(result); });
          
        firstconnect = false;
      }
      else {
        socket.socket.reconnect();
      }
    }
        
    function disconnect() {
      socket.disconnect();
    };
        
    function message(data) {
      document.getElementById('message').innerHTML = "Server says: " + data;
    };
        
    function status_update(txt){
      document.getElementById('status').innerHTML = txt;
    };
    
    function send() {
      //socket.send("Hello Server!");    
      console.log('wtf??');
      socket.emit('message', '{aaa: "bbb"}');
    };        
      
    // EVENTS
    function chat() {
      console.log('chatting...');
      socket.emit('chat', { message : 'testing...' });
    };

    function discard() {
      console.log('discarding..');
      var data = {
        id    : this.socketid, 
        cards : [1,2,4, 7]
      }
      socket.json.emit('discard',  data);
    };
    
    function targetMap() {
      var data = {
        id      : this.socketid,
        cardID  : 3,
        posx    : 1,
        posy    : 2
      };
    };
    
    function targetPerson() {
      var data = {
        id        : this.socketid,
        cardID    : 4,
        personID  : 2
      };
      
      
    };
    
    function heal() {
      var data = {
        
      };
    };
    
    function startGame(data) {
      //TODO: think about this shit...
      socket.emit('startGame');
      discard(); //TODO: testing phase...
    };
    
    // HANDLERS
    function handleDiscard(data) {
      console.log('got discard message back....');
      console.log(data);
    };

    function handleChat(message) {
      console.log('getting from server: ');
      console.log(message);
      document.getElementById('status').innerHTML += message.message;
    };

    function handleSetup(info) {
      console.log('got setup information');
      console.log(info);
      this.socketid = info.id;
      var data = {
        id    : socketid,
        name  : 'Mati'
      };
      this.socket.emit('setup', data);
    }
    
    function handleResult(result) {
      console.log('got result');
      console.log(result);
    };

    </script>
    
    <h1>Socket.io Test</h1>
    <div><p id="status">Waiting for input</p></div>
    <button id="discard" onClick='discard()'/>discard</button>
    <button id="targetMap" onClick='targetMap()'/>targetMap</button>
    <button id="targetPerson" onClick='targetPerson()'/>targetPerson</button>
    <button id="heal" onClick='heal()'/>heal</button>
    <button id="chat" onClick='chat()'/>chat</button>
    <button id="connect" onClick='connect()'/>connect</button>
    <button id="disconnect" onClick='disconnect()'>disconnect</button>
    <button id="send" onClick='send()'/>message</button>
    <button id="startGame" onClick='startGame()'/>START GAME</button>
  </body>
</html>
