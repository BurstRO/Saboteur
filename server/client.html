<html>
  <head>
    <title>Socket.io Test</title>
        
    <script src="/json.js"></script> <!-- for ie -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://localhost/Saboteur/js/jquery.js"></script>
    <script src="http://localhost/Saboteur/js/jquery.mouseToken.js"></script>
    <script src="http://localhost/Saboteur/js/jquery.progressBar.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/logger.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/inheritance.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Utils.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Preloader.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/SaboteurOptions.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Map.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Card.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/ActionCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/PathCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/GoalCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/LadderPathCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/CharacterCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/CrystalPathCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Factory.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/GatePathCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/GoldCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/MapClient.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Player.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Protocol.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/StartCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Saboteur.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/SaboteurClient.class.js"></script>
  </head>
  <body>
    
    <script>
        
    
    var socket;
    var firstconnect = true;
    var socketid = null; // the other end!!
    // var P = new Protocol();
    // TODO: HACK AWAY until I figure out how I should import everything :)
    var Protocol;

var Event = Class.extend({
//Event = Class.extend({
  init : function(name, data) {
    this.name = name;
    this.data = data;
  }
});

var Protocol;
( function() {
Protocol = {
//Protocol = Class.extend({
  state   : {
    CORRECT : 0,
    ERROR   : 1
  },
  events  : {
    server : {
      admin : {
        connect     : 'connect',
        disconnect  : 'disconnect',
        message     : 'message'
      },
      custom  : {
        chat                  : new Event('chat', {
          message : ''
        }),
        setup                 : new Event('setup', {
          playerID : 0,
          name     : ''
        }),
        doStartGame             : new Event('doStartGame', {
          // nothing so far..
        }),
        discard               : new Event('discard', {
          playerID  : '',
          cards     : []
        }), 
        targetPublicPerson    : new Event('targetPublicPerson', {
          playerID      : 0, // player
          cardID        : 0, // card
          targetID      : 0, // player
          targetCardID  : 0 // card
        }), 
        targetPrivatePerson   : new Event('targetPrivatePerson', {
          playerID      : 0, // player
          cardID        : 0, // card
          targetID      : 0 // player
        }),
        targetMap             : new Event('targetMap', {
          playerID      : 0, // player
          cardID        : 0, // card
          posx          : 0, // mapX
          posy          : 0 // mapY
        }), 
        heal                  : new Event('heal', {
          playerID      : 0, // player
          cards         : [], // card
          targetID      : 0 // card
        })
      }
    },
    client : {
      admin : {
        connect           : 'connect',
        disconnect        : 'disconnect',
        reconnect         : 'reconnect',
        reconnecting      : 'reconnecting',
        reconnect_failed  : 'reconnect_failed',
        message           : 'message'
      },
      custom : {
        chat      : new Event('chat', {
          playerID : 0, // player
          message  : ''
        }),
        setup     : new Event('setup', {
          playerID  : 0, // player
          name      : ''
        }),
        result    : {
          correct : new Event('result', {
            state : 0, // STATE
          }),
          error   : new Event('result', {
            state   : 0, // STATE
            map     : {}, // MAP
            players : [] // public player
          })
        },
        reset     : new Event('reset', {
          map     : {}, // MAP
          hand    : {}, // private player
          players : [] // public players
        })
      }
    }
  },
  createEvent : function(what, where, type, subtype) {
    var event = this.events[where][type];
    if (subtype) {
      event = event[subtype];
    };
    return U.extend({}, event);
  }
};
//});

})();

// TODO: END THE HAAAAACK!!!
    
    window.onLoad = connect();
        
    function connect() {
      if(firstconnect) {
        socket = io.connect(null);
          
        socket.on(Protocol.events.client.admin.message.name, function(data){ 
          message(data); 
        });
        
        socket.on(Protocol.events.client.admin.connect.name, function() { 
          status_update("Connected to Server"); 
        });
        
        socket.on(Protocol.events.client.admin.disconnect.name, function() { 
          status_update("Disconnected from Server"); 
        });
        
        socket.on(Protocol.events.client.admin.reconnect.name, function(){ 
          status_update("Reconnected to Server"); 
        });
        
        socket.on(Protocol.events.client.admin.reconnecting.name, function( nextRetry ) { 
          status_update("Reconnecting in " + nextRetry + " seconds"); 
        });
        
        socket.on(Protocol.events.client.admin.reconnect_failed.name, function() { 
          message("Reconnect Failed"); 
        });
        
        socket.on(Protocol.events.client.custom.chat.name, function(message) { 
          handleChat(message); 
        });
        
        socket.on(Protocol.events.client.custom.setup.name, function(info) {
          handleSetup(info);
        });
        
        socket.on(Protocol.events.client.custom.result.correct.name, function(result) { handleResult(result); });
        
        socket.on(Protocol.events.client.custom.reset.name, function(data) { handleReset(data); });
          
        firstconnect = false;
      }
      else {
        socket.socket.reconnect();
      }
    }
        
    function disconnect() {
      socket.disconnect();
    };
        
    function message(data) {
      document.getElementById('message').innerHTML = "Server says: " + data;
    };
        
    function status_update(txt){
      document.getElementById('status').innerHTML = txt;
    };
    
    function send() {
      //socket.send("Hello Server!");    
      console.log('wtf??');
      socket.emit('message', '{aaa: "bbb"}');
    };        
      
    // EVENTS
    function chat() {
      console.log('chatting...');
      socket.emit('chat', { message : 'testing...' });
    };

    function discard() {
      console.log('discarding..');
      //TODO: var data = Protocol.getEvent('discard', 'server', 'custom').data;
      var data = {
        playerID  : this.playerID, 
        cards     : [1,2,4]
      }
      socket.json.emit('discard',  data);
    };
    
    function doTargetMap() {
      //TODO: var data = Protocol.getEvent('targetMap', 'server', 'custom').data;
      var data = {
        playerID  : this.playerID,
        cardID    : 3,
        posx      : 1,
        posy      : 2
      };
      socket.json.emit('targetMap',  data);
    };
    
    function doTargetPublicPerson() {
      //TODO: var data = Protocol.getEvent('targetPublicPerson', 'server', 'custom').data;
      var data = {
        playerID      : this.playerID,
        cardID        : 4,
        targetID      : 2,
        targetCardID  : 100
      };
      
      socket.json.emit('targetPublicPerson',  data);
    };
    
    function doTargetPrivatePerson() {
      //TODO: var data = Protocol.getEvent('targetPrivatePerson', 'server', 'custom').data;
      
    };
    
    function doHeal() {
      //TODO: var data = Protocol.getEvent('heal', 'server', 'custom').data;
      var data = {
        playerID      : this.playerID,
        cards         : [1,2],
        targetCardID  : 100
      };
      socket.json.emit('discard',  data);
    };
    
    function doStartGame(data) {
      //TODO: think about this shit...
      socket.emit('startGame');
      console.log('starting game');
      setTimeout(discard, 1000); //TODO: testing phase...
    };
    
    // HANDLERS

    function handleChat(message) {
      console.log('getting from server: ');
      console.log(message);
      document.getElementById('status').innerHTML += message.message;
    };

    function handleSetup(info) {
      console.log('got setup information');
      console.log(info);
      this.playerID = info.playerID;
      //TODO: var data = Protocol.getEvent('setup', 'server', 'custom').data;
      var data = {
        playerID  : this.playerID,
        name      : 'Mati'
      };
      this.socket.emit('setup', data);
      //TODO: major hack, need a handshake
      setTimeout(doStartGame, 100);
    }
    
    function handleResult(result) {
      console.log('got result');
      console.log(result);
    };
    
    function handleReset(data) {
      console.log('got a reset request');
      console.log(data);
    };

    </script>
    
    <h1>Socket.io Test</h1>
    <div><p id="status">Waiting for input</p></div>
    <button id="discard" onClick='discard()'/>discard</button>
    <button id="doTargetMap" onClick='doTargetMap()'/>doTargetMap</button>
    <button id="targetPerson" onClick='doTargetPublicPerson()'/>doTargetPublicPerson</button>
    <button id="doHeal" onClick='doHeal()'/>doHeal</button>
    <button id="chat" onClick='chat()'/>chat</button>
    <button id="connect" onClick='connect()'/>connect</button>
    <button id="disconnect" onClick='disconnect()'>disconnect</button>
    <button id="send" onClick='send()'/>message</button>
    <button id="doStartGame" onClick='doStartGame()'/>START GAME</button>
  </body>
</html>
