<html>
  <head>
    <title>Socket.io Test</title>
        
    <script src="/json.js"></script> <!-- for ie -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://localhost/Saboteur/client/jquery/jquery.js"></script>
    <script src="http://localhost/Saboteur/client/jquery/jquery.mouseToken.js"></script>
    <script src="http://localhost/Saboteur/client/jquery/jquery.progressBar.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/logger.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/inheritance.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Utils.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/SaboteurOptions.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Map.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Card.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/ActionCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/PathCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/GoalCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/LadderPathCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/CrystalPathCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Factory.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/GatePathCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/GoldCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Player.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Protocol.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/StartCard.class.js"></script>
    <script type="text/javascript" src="http://localhost/Saboteur/lib/Saboteur.class.js"></script>
  </head>
  <body>
    
    <script>
        
    function status_update(txt){
      document.getElementById('status').innerHTML = txt;
    };
    
    function send() {
      //socket.send("Hello Server!");    
      console.log('wtf??');
      socket.emit('message', '{aaa: "bbb"}');
    };        
    
    var socket;
    var playerID;
    var firstconnect = true;
    var adminHandlers = U.extend({}, Protocol.events.client.admin);
    var handlers = U.extend({}, Protocol.events.client.custom);
    var actions = U.extend({}, Protocol.events.server.custom);
    
    // HANDLERS
    
    // ADMIN
    adminHandlers.disconnect.callback = function() {
      socket.disconnect();
    };
        
    adminHandlers.message.callback = function(data) {
      document.getElementById('message').innerHTML = "Server says: " + data;
    };
    
    adminHandlers.connect.callback =  function() { 
      status_update("Connected to Server"); 
    };
        
    adminHandlers.disconnect.callback = function() { 
      status_update("Disconnected from Server"); 
    };
        
    adminHandlers.reconnect.callback = function(){ 
      status_update("Reconnected to Server"); 
    };
        
    adminHandlers.reconnecting.callback = function( nextRetry ) { 
      status_update("Reconnecting in " + nextRetry + " seconds"); 
    };
    
    // CUSTOM

    handlers.chat.callback = function(data) {
      // TODO: this is bullshit, please do a chat system :))
      console.log('getting from server: ', data);
      document.getElementById('status').innerHTML += data.message;
    };

    handlers.setup.callback = function(data) {
      console.log('got setup information');
      console.log(data);
      playerID = data.playerID;
      // TODO: name should be gotten from an interface somehow..preset! 
      // You should not call doSetup here, but rather when ready..
      actions.setup.callback({}); //TODO: even if call from here, instantiate
    };
    
    handlers.result.callback = function(data) {
      //TODO: handle results?
    };
    
    handlers.reset.callback = function(data) {
      console.log('got a reset request');
      console.log(data);
      player = data.players[playerID];
      //TODO: reset all state...in the SaboteurClient maybe?
    };
      
    // ACTIONS
    
    // CUSTOM
    // TODO: when we actually use this and not just test it, like now
    // basically you just pass the Protocol.event that the function needs, and you send it
    actions.chat.callback = function(data) {
      var data = Protocol.createEvent('chat', 'server', 'custom').data;
      // data.message = message;
      data.message = 'testing...';
      socket.emit('chat', data);
    };

    actions.discard.callback = function (data) {
      var data = Protocol.createEvent('discard', 'server', 'custom').data;
      data.playerID = playerID
      data.cards = [ player.private.cards[0] ];
      
      socket.json.emit('discard', data);
    };
    
    actions.targetMap.callback = function (data) {
      var data = Protocol.createEvent('targetMap', 'server', 'custom').data;
      data.playerID = playerID;
      data.cardID   = 3;
      data.posx     = 1;
      data.posy     = 2;
      
      socket.json.emit('targetMap',  data);
    };
    
    actions.targetPublicPerson.callback = function(data) {
      var data = Protocol.createEvent('targetPublicPerson', 'server', 'custom').data;
      data.playerID = playerID;
      data.targetID = playerID;
      data.targetCardID = 100;
      
      socket.json.emit('targetPublicPerson',  data);
    };
    
    actions.targetPrivatePerson.callback = function(data) {
      var data = Protocol.createEvent('targetPrivatePerson', 'server', 'custom').data;
      // data.cardID = cardID;
      // data.targetID = targetID;
      data.playerID = playerID;
      // TODO: hack...fix later :p
      data.cardID = player.private.cards[0];
      data.targetID = playerID;
      
      socket.json.emit('targetPrivatePerson', data);
    };
    
    actions.heal.callback = function(data) {
      var data = Protocol.createEvent('heal', 'server', 'custom').data;
      // data.cards = cards;
      // data.targetCardID = targetCardID;
      data.playerID = playerID;
      // TODO: hack...fix later :p
      data.cardID = player.private.cards[0];
      data.targetCardID = 100;
      
      socket.json.emit('discard',  data);
    };
    
    actions.setup.callback = function(data) {
      var data = Protocol.createEvent('setup', 'server', 'custom').data;
      data.playerID = playerID;
      data.name = 'Mati';
      
      socket.emit('setup', data);
      //TODO: major hack, need a handshake until you start game, 
      // or some form of ACK mechanism, mb even call start separately...
      setTimeout(actions.startGame.callback, 100);
    };
    
    actions.startGame.callback = function(data) {
      //TODO: think about this shit...
      console.log('starting game');
      socket.emit('startGame', data);
      //TODO: testing phase...
      setTimeout(actions.discard.callback, 1000); 
    };
      
    window.onLoad = connect();
        
    function connect() {
      if(firstconnect) {
        socket = io.connect(null);
          
        for (var a in adminHandlers) {
          socket.on(adminHandlers[a].name, adminHandlers[a].callback);
        };  
        
        for (var h in handlers) {
          socket.on(handlers[h].name , handlers[h].callback);
        };
        
        /*
        for (var h in handlers) {
          var name = handlers[h].name
          console.log(name);
          socket.on(name, function(data) {
            if (name != data._name) {
              throw new Error('Invalid datatype ' + data._name + ' for event ' + name);
            } else {
              console.log('handling event:',handlers[h].name);
              console.log(data);
              return handlers[h].callback.call(this, data);
            };
          });
        }
        */
        
        //setTimeout(actions.setup.callback, 100 );

        firstconnect = false;
      }
      else {
        socket.socket.reconnect();
      }
    }
    
    </script>
    
    <h1>Socket.io Test</h1>
    <div><p id="status">Waiting for input</p></div>
    <button id="discard" onClick='discard()'/>discard</button>
    <button id="doTargetMap" onClick='doTargetMap()'/>doTargetMap</button>
    <button id="targetPerson" onClick='doTargetPublicPerson()'/>doTargetPublicPerson</button>
    <button id="doHeal" onClick='doHeal()'/>doHeal</button>
    <button id="chat" onClick='chat()'/>chat</button>
    <button id="connect" onClick='connect()'/>connect</button>
    <button id="disconnect" onClick='disconnect()'>disconnect</button>
    <button id="send" onClick='send()'/>message</button>
    <button id="doStartGame" onClick='doStartGame()'/>START GAME</button>
  </body>
</html>
